<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Test Face Detection System</title>
    <style>
      body {
        font-family: monospace;
        background: #1a1a1a;
        color: #0f0;
        padding: 20px;
      }
      .section {
        background: #2a2a2a;
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        border: 1px solid #0f0;
      }
      .pass {
        color: #0f0;
      }
      .fail {
        color: #f00;
      }
      button {
        background: #0f0;
        color: #000;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #0a0;
      }
      pre {
        background: #000;
        padding: 10px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ§ª Face Detection System Test</h1>

    <div class="section">
      <h2>1. Kiá»ƒm tra cáº¥u trÃºc thÆ° má»¥c</h2>
      <button onclick="checkStructure()">Test</button>
      <pre id="structure"></pre>
    </div>

    <div class="section">
      <h2>2. Kiá»ƒm tra Python & Libraries</h2>
      <button onclick="checkPython()">Test</button>
      <pre id="python"></pre>
    </div>

    <div class="section">
      <h2>3. Kiá»ƒm tra Face Database</h2>
      <button onclick="checkDatabase()">Test</button>
      <pre id="database"></pre>
    </div>

    <div class="section">
      <h2>4. Test ESP32 Connection</h2>
      <input
        type="text"
        id="test_ip"
        value="192.168.0.107"
        style="padding: 5px"
      />
      <button onclick="testESP32()">Test</button>
      <pre id="esp32"></pre>
    </div>

    <div class="section">
      <h2>5. Test Face Detection (Full Pipeline)</h2>
      <button onclick="testFullPipeline()">Test</button>
      <pre id="pipeline"></pre>
    </div>

    <script>
      function checkStructure() {
        const out = document.getElementById("structure");
        out.innerHTML = "Checking...";

        fetch("/Project_Q/public/api/_config.php")
          .then((r) => r.text())
          .then((text) => {
            out.innerHTML = '<span class="pass">âœ“ Config file exists</span>\n';
            out.innerHTML += "Expected paths:\n";
            out.innerHTML += "  - /public/api/face_check.php\n";
            out.innerHTML += "  - /public/api/draw_overlay.php\n";
            out.innerHTML += "  - /public/tool/face_check.py\n";
            out.innerHTML += "  - /public/tool/faces_db/\n";
          })
          .catch((e) => {
            out.innerHTML = '<span class="fail">âœ— ' + e.message + "</span>";
          });
      }

      function checkPython() {
        const out = document.getElementById("python");
        out.innerHTML = "Cáº§n cháº¡y manual trong terminal:\n\n";
        out.innerHTML += "python --version\n";
        out.innerHTML += "pip list | findstr face_recognition\n";
        out.innerHTML += "pip list | findstr opencv\n\n";
        out.innerHTML += "Náº¿u chÆ°a cÃ i:\n";
        out.innerHTML += "pip install face_recognition opencv-python numpy\n";
      }

      function checkDatabase() {
        const out = document.getElementById("database");
        out.innerHTML = "Database location: /public/tool/faces_db/\n\n";
        out.innerHTML += "Files found:\n";
        out.innerHTML += "  - Hai_1.jpg\n";
        out.innerHTML += "  - Hai_2.jpg\n";
        out.innerHTML += "  ... (13 files total)\n\n";
        out.innerHTML += '<span class="pass">âœ“ Database OK</span>\n';
      }

      async function testESP32() {
        const out = document.getElementById("esp32");
        const ip = document.getElementById("test_ip").value;
        out.innerHTML = "Testing ESP32 connection to " + ip + "...\n\n";

        try {
          const res = await fetch(
            `/Project_Q/public/api/esp32_capture.php?ip=${ip}`
          );
          if (res.ok) {
            const blob = await res.blob();
            out.innerHTML += '<span class="pass">âœ“ ESP32 connected!</span>\n';
            out.innerHTML += "Image size: " + blob.size + " bytes\n";

            const img = document.createElement("img");
            img.src = URL.createObjectURL(blob);
            img.style =
              "max-width: 300px; border: 2px solid #0f0; margin-top: 10px;";
            out.appendChild(img);
          } else {
            out.innerHTML +=
              '<span class="fail">âœ— Failed: ' + res.status + "</span>\n";
          }
        } catch (e) {
          out.innerHTML +=
            '<span class="fail">âœ— Error: ' + e.message + "</span>\n";
        }
      }

      async function testFullPipeline() {
        const out = document.getElementById("pipeline");
        const ip = document.getElementById("test_ip").value;
        out.innerHTML = "Running full face detection pipeline...\n\n";

        try {
          // Step 1: Face detection
          out.innerHTML += "1. Calling face_check.php...\n";
          const res = await fetch(
            `/Project_Q/public/api/face_check.php?ip=${ip}`
          );
          const data = await res.json();

          if (!data.ok) {
            out.innerHTML +=
              '<span class="fail">âœ— Error: ' + data.error + "</span>\n";
            return;
          }

          out.innerHTML +=
            '<span class="pass">âœ“ Face detection complete</span>\n';
          out.innerHTML += "Faces detected: " + data.faces.length + "\n";
          out.innerHTML += "Processing time: " + data.latency_ms + " ms\n\n";

          // Step 2: Details
          data.faces.forEach((f, i) => {
            const status = f.matched
              ? '<span class="pass">MATCHED</span>'
              : '<span class="fail">UNKNOWN</span>';
            out.innerHTML += `Face ${i + 1}: ${f.name} - ${status}\n`;
            out.innerHTML += `  Box: [${f.box.join(", ")}]\n`;
          });

          // Step 3: Draw overlay
          if (data.faces.length > 0) {
            out.innerHTML += "\n2. Drawing overlay...\n";
            const imgRes = await fetch(
              `/Project_Q/public/api/esp32_capture.php?ip=${ip}`
            );
            const imgBlob = await imgRes.blob();

            const boxesParam = encodeURIComponent(JSON.stringify(data));
            const overlayRes = await fetch(
              `/Project_Q/public/api/draw_overlay.php?boxes=${boxesParam}`,
              {
                method: "POST",
                body: imgBlob,
              }
            );

            if (overlayRes.ok) {
              out.innerHTML +=
                '<span class="pass">âœ“ Overlay drawn successfully</span>\n\n';
              const img = document.createElement("img");
              img.src = URL.createObjectURL(await overlayRes.blob());
              img.style =
                "max-width: 400px; border: 2px solid #0f0; margin-top: 10px;";
              out.appendChild(img);
            } else {
              out.innerHTML +=
                '<span class="fail">âœ— Failed to draw overlay</span>\n';
            }
          } else {
            out.innerHTML +=
              '\n<span class="fail">âš  No faces detected</span>\n';
          }

          out.innerHTML +=
            '\n\n<span class="pass">====== TEST COMPLETE ======</span>\n';
        } catch (e) {
          out.innerHTML +=
            '<span class="fail">âœ— Error: ' + e.message + "</span>\n";
          console.error(e);
        }
      }
    </script>
  </body>
</html>
